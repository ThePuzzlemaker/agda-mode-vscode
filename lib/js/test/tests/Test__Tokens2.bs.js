// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var Vscode = require("vscode");
var $$Promise = require("reason-promise/lib/js/src/js/promise.bs.js");
var Belt_Array = require("rescript/lib/js/belt_Array.js");
var Caml_option = require("rescript/lib/js/caml_option.js");
var Mocha$BsMocha = require("bs-mocha/lib/js/src/Mocha.bs.js");
var Config$AgdaModeVscode = require("../../src/Config.bs.js");
var Editor$AgdaModeVscode = require("../../src/Editor.bs.js");
var Tokens$AgdaModeVscode = require("../../src/Tokens.bs.js");
var Source$LanguageServerMule = require("language-server-mule/lib/js/src/Source.bs.js");
var Test__Util$AgdaModeVscode = require("./Test__Util.bs.js");
var Connection__Emacs$AgdaModeVscode = require("../../src/Connection/Emacs/Connection__Emacs.bs.js");
var Connection__Error$AgdaModeVscode = require("../../src/Connection/Connection__Error.bs.js");
var Connection__Emacs__Error$AgdaModeVscode = require("../../src/Connection/Emacs/Connection__Emacs__Error.bs.js");

function toString(x) {
  if (x.TAG === /* LanguageServerMuleErrors */0) {
    return Belt_Array.map(x._0, Source$LanguageServerMule.$$Error.toString).join(",");
  }
  var match = Connection__Emacs__Error$AgdaModeVscode.toString(x._0);
  return "EmacsConnectionError: " + match[0] + ": " + match[1];
}

var $$Error = {
  toString: toString
};

function exists(command) {
  return $$Promise.flatMapError($$Promise.flatMap(Source$LanguageServerMule.Module.searchUntilSuccess([{
                        TAG: 1,
                        _0: command,
                        [Symbol.for("name")]: "FromCommand"
                      }]), (function (param) {
                    if (param[0] !== undefined) {
                      return $$Promise.resolved({
                                  TAG: 0,
                                  _0: undefined,
                                  [Symbol.for("name")]: "Ok"
                                });
                    } else {
                      return $$Promise.resolved({
                                  TAG: 1,
                                  _0: param[1],
                                  [Symbol.for("name")]: "Error"
                                });
                    }
                  })), (function (errors) {
                var msg = Belt_Array.map(errors, Source$LanguageServerMule.$$Error.toString).join(",");
                return Test__Util$AgdaModeVscode.A.fail("Cannot find \"Agda\" in PATH: " + msg);
              }));
}

var Agda = {
  $$Error: $$Error,
  exists: exists
};

function acquire(setup) {
  var setup$1 = setup.contents;
  if (setup$1 !== undefined) {
    return $$Promise.resolved({
                TAG: 0,
                _0: Caml_option.valFromOption(setup$1),
                [Symbol.for("name")]: "Ok"
              });
  } else {
    return Test__Util$AgdaModeVscode.A.fail("Cannot acquire the setup");
  }
}

function cleanup(setup) {
  var conn = setup.contents;
  if (conn !== undefined) {
    return Connection__Emacs$AgdaModeVscode.destroy(Caml_option.valFromOption(conn));
  } else {
    return $$Promise.resolved(undefined);
  }
}

Mocha$BsMocha.describe("Tokens")(10000, undefined, undefined, (function (param) {
        var channels = {
          contents: undefined
        };
        var acquire = function (filepath) {
          var _channels = channels.contents;
          if (_channels === undefined) {
            return Test__Util$AgdaModeVscode.A.fail("Cannot activate the extension");
          }
          var filepath$1 = Test__Util$AgdaModeVscode.Path.asset(filepath);
          return $$Promise.flatMap($$Promise.flatMap(Test__Util$AgdaModeVscode.openFile(filepath$1), (function (param) {
                            return Vscode.commands.executeCommand("agda-mode.load");
                          })), (function (result) {
                        if (result === undefined) {
                          return Test__Util$AgdaModeVscode.A.fail("Cannot load " + filepath$1);
                        }
                        if (result.TAG === /* Ok */0) {
                          return $$Promise.resolved({
                                      TAG: 0,
                                      _0: result._0,
                                      [Symbol.for("name")]: "Ok"
                                    });
                        }
                        var match = Connection__Error$AgdaModeVscode.toString(result._0);
                        return Test__Util$AgdaModeVscode.A.fail(match[0] + "\n" + match[1]);
                      }));
        };
        Test__Util$AgdaModeVscode.Q.before(function (param) {
              Config$AgdaModeVscode.inTestingMode.contents = true;
              return $$Promise.tap($$Promise.flatMap($$Promise.flatMap(Config$AgdaModeVscode.Connection.setAgdaVersion("agda"), (function (param) {
                                    return Config$AgdaModeVscode.Connection.setUseAgdaLanguageServer(false);
                                  })), (function (param) {
                                return exists("agda");
                              })), (function (param) {
                            channels.contents = Test__Util$AgdaModeVscode.activateExtension(undefined);
                            
                          }));
            });
        return Mocha$BsMocha.describe("GotoDefinition.agda")(undefined, undefined, undefined, (function (param) {
                      Test__Util$AgdaModeVscode.Q.it("should produce correct tokens", (function (param) {
                              return $$Promise.flatMapOk(acquire("GotoDefinition.agda"), (function (state) {
                                            var tokens = Belt_Array.map(Tokens$AgdaModeVscode.toArray(state.tokens), (function (param) {
                                                    return Editor$AgdaModeVscode.$$Range.toString(param[1]) + " " + Tokens$AgdaModeVscode.Token.toString(param[0]);
                                                  }));
                                            return Test__Util$AgdaModeVscode.A.deep_equal([
                                                        "0:0-6 Token (0, 6) [Keyword]",
                                                        "0:7-21 Token (7, 21) [Module] [src: 1]",
                                                        "0:22-27 Token (22, 27) [Keyword]",
                                                        "1:0-4 Token (28, 32) [Keyword]",
                                                        "1:5-6 Token (33, 34) [Datatype] [src: 34]",
                                                        "1:7-8 Token (35, 36) [Symbol]",
                                                        "1:9-12 Token (37, 40) [Primitive] [src: 326]",
                                                        "1:13-18 Token (41, 46) [Keyword]",
                                                        "2:2-3 Token (49, 50) [ConstructorInductive] [src: 50]",
                                                        "2:4-5 Token (51, 52) [Symbol]",
                                                        "2:6-7 Token (53, 54) [Datatype] [src: 34]",
                                                        "3:2-3 Token (57, 58) [ConstructorInductive] [src: 58]",
                                                        "3:4-5 Token (59, 60) [Symbol]",
                                                        "3:6-7 Token (61, 62) [Datatype] [src: 34]",
                                                        "3:8-9 Token (63, 64) [Symbol]",
                                                        "3:10-11 Token (65, 66) [Datatype] [src: 34]",
                                                        "5:0-3 Token (68, 71) [Function, Operator] [src: 69]",
                                                        "5:4-5 Token (72, 73) [Symbol]",
                                                        "5:6-7 Token (74, 75) [Datatype] [src: 34]",
                                                        "5:8-9 Token (76, 77) [Symbol]",
                                                        "5:10-11 Token (78, 79) [Datatype] [src: 34]",
                                                        "5:12-13 Token (80, 81) [Symbol]",
                                                        "5:14-15 Token (82, 83) [Datatype] [src: 34]",
                                                        "6:0-1 Token (84, 85) [Bound] [src: 85]",
                                                        "6:2-3 Token (86, 87) [Function, Operator] [src: 69]",
                                                        "6:4-5 Token (88, 89) [Bound] [src: 89]",
                                                        "6:6-7 Token (90, 91) [Symbol]",
                                                        "6:8-15 Token (92, 99) [Hole]"
                                                      ], tokens);
                                          }));
                            }));
                      return Test__Util$AgdaModeVscode.Q.it("should produce correct tokens after inserting a space", (function (param) {
                                    return $$Promise.flatMapOk($$Promise.flatMapOk(acquire("GotoDefinition.agda"), (function (state) {
                                                      var position = new Vscode.Position(6, 7);
                                                      return $$Promise.map(Editor$AgdaModeVscode.$$Text.insert(state.document, position, " "), (function (param) {
                                                                    return {
                                                                            TAG: 0,
                                                                            _0: state,
                                                                            [Symbol.for("name")]: "Ok"
                                                                          };
                                                                  }));
                                                    })), (function (state) {
                                                  var tokens = Belt_Array.map(Tokens$AgdaModeVscode.toArray(state.tokens), (function (param) {
                                                          return Editor$AgdaModeVscode.$$Range.toString(param[1]) + " " + Tokens$AgdaModeVscode.Token.toString(param[0]);
                                                        }));
                                                  return Test__Util$AgdaModeVscode.A.deep_equal([
                                                              "0:0-6 Token (0, 6) [Keyword]",
                                                              "0:7-21 Token (7, 21) [Module] [src: 1]",
                                                              "0:22-27 Token (22, 27) [Keyword]",
                                                              "1:0-4 Token (28, 32) [Keyword]",
                                                              "1:5-6 Token (33, 34) [Datatype] [src: 34]",
                                                              "1:7-8 Token (35, 36) [Symbol]",
                                                              "1:9-12 Token (37, 40) [Primitive] [src: 326]",
                                                              "1:13-18 Token (41, 46) [Keyword]",
                                                              "2:2-3 Token (49, 50) [ConstructorInductive] [src: 50]",
                                                              "2:4-5 Token (51, 52) [Symbol]",
                                                              "2:6-7 Token (53, 54) [Datatype] [src: 34]",
                                                              "3:2-3 Token (57, 58) [ConstructorInductive] [src: 58]",
                                                              "3:4-5 Token (59, 60) [Symbol]",
                                                              "3:6-7 Token (61, 62) [Datatype] [src: 34]",
                                                              "3:8-9 Token (63, 64) [Symbol]",
                                                              "3:10-11 Token (65, 66) [Datatype] [src: 34]",
                                                              "5:0-3 Token (68, 71) [Function, Operator] [src: 69]",
                                                              "5:4-5 Token (72, 73) [Symbol]",
                                                              "5:6-7 Token (74, 75) [Datatype] [src: 34]",
                                                              "5:8-9 Token (76, 77) [Symbol]",
                                                              "5:10-11 Token (78, 79) [Datatype] [src: 34]",
                                                              "5:12-13 Token (80, 81) [Symbol]",
                                                              "5:14-15 Token (82, 83) [Datatype] [src: 34]",
                                                              "6:0-1 Token (84, 85) [Bound] [src: 85]",
                                                              "6:2-3 Token (86, 87) [Function, Operator] [src: 69]",
                                                              "6:4-5 Token (88, 89) [Bound] [src: 89]",
                                                              "6:6-7 Token (90, 91) [Symbol]",
                                                              "6:9-16 Token (93, 100) [Hole]"
                                                            ], tokens);
                                                }));
                                  }));
                    }));
      }));

exports.Agda = Agda;
exports.acquire = acquire;
exports.cleanup = cleanup;
/*  Not a pure module */
